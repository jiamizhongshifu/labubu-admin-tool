# Jitata - 潮玩虚拟图鉴应用

一个创新的潮玩收集应用，让你轻松拍摄、收集和管理你的潮流玩具。

## ✨ 核心功能

### 📸 智能拍摄系统
- **真实相机预览**: 集成AVFoundation，提供实时相机画面
- **专业拍摄界面**: 
  - 左上角显示当天日期和拍摄提示
  - 中央280x280像素取景框，四角装饰线设计
  - 底部80像素圆形拍摄按钮和60像素方形相册入口
  - 黑色专业背景，营造拍摄氛围
- **权限管理**: 完善的相机权限检查和模拟器适配
- **拍摄状态指示**: 实时显示拍摄进度和状态

### 🖼️ 拍摄预览系统
- **智能预览界面**: 拍摄完成后自动跳转到预览页面
- **透明背景抠图**: AI自动抠图生成PNG格式的透明背景图像 ✨
- **操作按钮组**:
  - **裁剪按钮**: 支持图片裁剪功能
  - **确认按钮**: 保存到图鉴
  - **取消按钮**: 重新拍摄
- **识别模式切换**: 右上角按钮可切换显示原图或抠图结果
- **实时处理状态**: 显示图像处理进度

### 🎨 AI智能抠图与增强
- **透明背景生成**: 使用Vision框架生成真正的透明背景PNG图像 ✨
- **AI图片增强**: 集成OpenAI gpt-image-1模型，自动增强抠图后的主体图像 ✨
- **智能提示词**: 根据不同分类（玩具、手办、模型、卡片等）使用专门优化的提示词
- **网络优化**（已全面增强）:
  - 超时配置: 请求60秒，资源180秒（针对小文件传输优化）
  - 智能重试: 最多3次，指数退避算法（最大30秒延迟）
  - 网络检查: 增强前自动检查连接状态和API服务器连通性
  - 错误分类: 区分可重试和不可重试错误，针对性处理
  - 延迟策略: 网络连接问题10秒基础延迟，超时问题8秒，连接问题6秒
  - 连接优化: 使用"Connection: close"避免连接复用问题，禁用缓存和管道
  - 图片极度压缩: 限制50KB以内，尺寸256px，质量0.03-0.3，确保传输成功率
- **多重算法支持**: 
  - Vision框架主体分离
  - VisionKit高级处理
  - 人像分割降级方案
- **智能降级机制**: 自动选择最佳处理方案
- **精确蒙版处理**: 使用CIBlendWithMask确保透明背景效果

### 📱 用户界面
- **现代化主页**: 渐变背景设计，卡片式功能入口
- **完善的导航系统**: ✨
  - 图鉴页面添加返回按钮
  - 清晰的导航栏标题显示
  - 一致的用户体验流程
- **响应式设计**: 适配不同iOS设备尺寸

### 🗂️ 图鉴管理
- **分类收藏**: 支持玩具、手办、模型、卡片等分类
- **智能搜索**: 按名称、分类、备注搜索
- **多视图模式**: 网格视图和列表视图切换
- **详细信息**: 每个潮玩包含完整的收藏信息
- **AI增强状态**: 显示图片增强进度和状态

### 🎬 动态壁纸生成系统 ✨
- **AI增强优先**: 只有AI增强的图像才能生成动态壁纸，确保最佳质量
- **Kling API集成**: 使用先进的视频生成技术创建动态效果
- **宽高比选择**: 支持8种标准比例（1:1, 4:3, 3:4, 16:9, 9:16, 3:2, 2:3, 21:9）
- **手机优化**: 默认9:16竖屏比例，完美适配手机壁纸
- **丰富模板**: 多种视频效果模板，满足不同审美需求
- **自定义提示**: 支持用户自定义视频效果描述

### 💾 本地视频存储系统 ✨
- **智能存储策略**:
  - ✅ 视频生成完成后自动下载到本地
  - 🏠 本地存储路径：`Documents/Videos/video_{stickerID}.mp4`
  - 🔄 优先级：本地视频 > 云端视频
  - 📱 跨设备同步：通过云端URL支持设备间同步

- **播放优化**:
  - 🚀 本地视频秒开，无需网络加载
  - 🌐 云端视频备用，确保可用性
  - ⬇️ 后台智能下载，不阻塞播放体验
  - 💾 存储空间智能管理

- **用户体验**:
  - 📊 下载进度实时显示
  - ✅ 下载状态清晰反馈
  - 🔧 自动错误处理和重试
  - 📱 离线播放支持

### 🎨 自定义壁纸系统
- **用户优先**: 生成的动态壁纸优先显示为应用背景
- **壁纸选择**: 2列网格展示所有生成的视频，支持预览和选择
- **设置持久化**: 用户选择的壁纸设置自动保存，应用重启后恢复
- **一键重置**: 支持重置到默认预设壁纸

## 🛠️ 技术栈

- **语言**：Swift 5.9+
- **框架**：SwiftUI
- **最低版本**：iOS 16.0+
- **核心技术**：
  - VisionKit：智能图像分析和背景移除
  - SwiftData：本地数据持久化
  - Core Image：图像处理和特效
  - AVFoundation：相机功能
  - OpenAI API：AI图片增强服务

## 🔧 开发环境配置

### 系统要求
- Xcode 15.0+
- iOS 16.0+ 模拟器或真机
- macOS 14.0+

### 环境变量配置
应用需要配置OpenAI API密钥以启用AI图片增强功能：

#### 方法一：.env文件配置（推荐）
在项目根目录创建`.env`文件：
```bash
# OpenAI API配置
TUZI_API_KEY=your_api_key_here
TUZI_API_BASE=https://api.tu-zi.com/v1
```

#### 方法二：环境变量
```bash
export TUZI_API_KEY="your_api_key_here"
export TUZI_API_BASE="https://api.tu-zi.com/v1"
```

#### 方法三：Info.plist配置（开发环境）
在项目的Info.plist中添加：
```xml
<key>OPENAI_API_KEY</key>
<string>your_api_key_here</string>
```

#### API密钥获取
- 访问 [api.tu-zi.com](https://api.tu-zi.com) 注册账号
- 创建API密钥时选择OpenAI、OpenAI原价或default分组
- 复制密钥并配置到环境变量中

**注意**: 请确保API密钥的安全性，不要将其提交到版本控制系统中。

## 📱 界面设计

### 拍照界面特色
- **黑色背景**：专业的拍照体验
- **日期显示**：左上角显示当前日期（如"6月04日"）
- **拍摄提示**：清晰的操作指导文字
- **取景框**：280x280的圆角矩形框，带有四角装饰线
- **拍摄按钮**：80px圆形白色按钮，简洁优雅
- **相册入口**：右下角60px方形按钮，便于选择已有照片

## 🚀 开发进度

- [x] **Phase 1: 基础架构** - 项目结构和数据模型
- [x] **Phase 2: 拍照功能** - 相机集成和图像处理
- [x] **Phase 3: 图鉴功能** - 收藏管理和展示
- [x] **Phase 4: 界面优化** - 现代化拍照界面设计
- [x] **Phase 5: 用户体验** - 主页设计和流程优化
- [x] **Phase 6: 预览系统** - 真实相机预览和拍摄预览
- [x] **Phase 7: 功能完善** - 分享、导出等高级功能
- [x] **Phase 8: 透明背景修复** - 修复抠图白色背景问题
- [x] **Phase 9: 导航体验优化** - 优化图鉴页面导航
- [x] **Phase 10: AI图片增强** - 集成OpenAI API实现智能图片增强

## 📋 最新更新

### v3.0.0 - 本地视频存储系统 ✨
- 🎬 新增动态壁纸生成功能，支持AI增强图像生成动态视频
- 💾 实现本地视频存储系统，自动下载视频到本地
- 🚀 智能播放器优先使用本地视频，提升播放性能
- 📊 完善的下载进度和状态管理系统
- ⬇️ 后台下载不阻塞用户体验
- 🎨 自定义壁纸系统，支持用户选择动态背景
- 📐 8种宽高比选择，满足不同设备需求
- 🔄 跨设备云端同步支持
- 📱 离线播放功能，无网络也能欣赏动态壁纸

### v2.0.2 - API配置标准化
- 🔧 API配置优化：支持TUZI_API_KEY和TUZI_API_BASE环境变量
- 📁 .env文件支持：优先从.env文件读取API配置
- 🔄 向后兼容：保持对OPENAI_API_KEY的支持
- 📊 调试信息增强：显示API配置加载状态
- 🛠️ 参数优化：移除无效的quality参数，添加n参数

### v2.0.1 - AI增强网络优化
- 🔧 修复API参数错误：quality参数从"hd"改为"high"
- 🌐 网络连接优化：增加超时时间到120秒/300秒
- 🔄 智能重试策略：网络连接问题使用5-15秒延迟
- 📡 连接稳定性提升：禁用缓存，优化连接设置
- 🛠️ 错误处理改进：更精确的网络错误分类和处理

### v2.0.0 - AI图片增强功能
- 🤖 集成OpenAI gpt-image-1模型，实现AI图片增强
- 🎯 智能提示词管理，针对不同分类优化增强效果
- 🔄 自动增强流程，保存图片后自动触发AI增强
- 📊 增强状态管理，实时显示处理进度
- 🎨 优先显示增强后的图片，提升视觉效果
- 🔧 环境变量配置，安全管理API密钥
- 💾 智能存储管理，为Supabase迁移做准备

### v1.4.0 - 新增真实相机预览和拍摄预览
- 🎨 全新的拍照界面设计
- 📅 添加日期显示功能
- 🎯 精美的取景提示框
- 🔘 优化拍摄按钮和相册入口布局
- 🐛 修复编译警告和代码优化
- 🎨 新增真实相机预览和拍摄预览功能
- 🎨 实时显示拍摄进度和状态

## 📝 使用说明

1. **环境配置**：配置OpenAI API密钥到环境变量
2. **进入应用**：启动后看到精美的主页，选择功能入口
3. **拍照收集**：点击"拍照收集"进入拍摄界面
4. **实时预览**：查看相机画面和取景框
5. **点击拍摄**：自动拍照并处理
6. **预览确认**：查看抠图结果，可裁剪调整
7. **保存收藏**：为你的潮玩起个名字，选择分类，保存到图鉴
8. **AI增强**：系统自动调用AI服务增强图片质量
9. **生成壁纸**：AI增强完成后，点击"生成动态壁纸"按钮
10. **选择效果**：选择宽高比和视频效果描述
11. **自动下载**：视频生成完成后自动下载到本地存储
12. **设置壁纸**：在主页点击壁纸设置，选择喜欢的动态壁纸
13. **管理查看**：在"我的图鉴"中查看和管理所有收藏

## 🎯 设计理念

Jitata致力于为潮玩爱好者提供最简单、最智能的收集体验。通过先进的AI技术和精美的界面设计，让每一次拍摄都成为艺术创作。AI增强功能让普通的拍摄照片变得更加精美，动态壁纸生成让每个潮玩都拥有独特的动态展示效果。本地视频存储系统确保用户的创作成果永久保存，随时随地都能欣赏自己的潮玩动态图鉴。

## 📚 技术文档

- [VisionKit 官方文档](https://developer.apple.com/documentation/visionkit)
- [OpenAI API 文档](https://api.tu-zi.com)

---

*让每个潮玩都有自己的数字身份* 🎭 

## 技术实现细节

### AI图片增强模块 (ImageEnhancementService)

**核心功能**: 使用OpenAI API对潮玩图片进行AI增强处理

**API调用合规性**: ✅ 完全符合官方文档标准
- **API端点**: `/images/edits` - 符合官方文档（已修复404错误）
- **环境变量**: 支持 `TUZI_API_KEY` 和 `TUZI_API_BASE`（官方推荐）
- **向后兼容**: 同时支持 `OPENAI_API_KEY`（向后兼容）
- **配置来源**: 环境变量 → .env文件 → Info.plist → 硬编码备选

**请求参数**（完全符合官方文档）:
- `model`: "gpt-image-1" - 官方推荐模型
- `image`: PNG格式图片数据（必需）
- `prompt`: 分类特定的增强提示词（必需）
- `size`: "1024x1024" - 标准尺寸

# jitata - iOS 贴纸相机应用

## 项目概述
jitata 是一个功能丰富的 iOS 贴纸相机应用，支持拍照、AI 图像增强、视频生成等功能。

## 最新更新

### 📸 拍摄页面取景框优化 (2024-12-06)

**新增功能：**
1. **参考图样式取景框设计**
   - 完全按照参考图设计，去除外边矩形边框
   - 只保留4个断开的圆角装饰，更加简洁现代
   - 带圆角的L型角标，提供专业的拍摄体验
   - 优化的视觉层次和对比度

2. **点击对焦功能**
   - 点击屏幕任意位置，取景框会移动到点击位置
   - 自动对焦到点击指向的物体
   - 流畅的动画效果，提供即时的视觉反馈
   - 触觉反馈增强用户体验

**技术实现：**
- 修改了 `CameraView.swift` 中的取景框布局和交互逻辑
- 创建了 `ReferenceCornerBracket` 组件，完全还原参考图样式
- 优化了 `CameraPreviewView.swift` 支持外部点击处理
- 实现了坐标转换和安全范围限制
- 集成了 `HapticFeedbackManager` 提供触觉反馈

**设计细节：**
- 取景框尺寸：120x120 像素
- 角标线长：20 像素，线宽：2 像素
- 圆角半径：4 像素，使用 `addQuadCurve` 实现平滑圆角
- 动画效果：0.3秒缩放动画，透明度变化

**用户体验改进：**
- 更直观的对焦操作
- 高度还原参考图的专业相机界面设计
- 即时的触觉和视觉反馈
- 流畅的动画过渡效果

### 🎯 触觉反馈系统 (之前更新)

**已实现功能：**
- 统一的轻触反馈系统
- 覆盖全应用38个交互点
- 10个主要组件的完整集成
- 提升用户交互质量

## 核心功能

### 📷 相机功能
- 高质量照片拍摄
- 实时相机预览
- 点击对焦和自动对焦
- 现代化取景框界面
- 照片库访问

### 🎨 AI 图像处理
- AI 图像增强
- 背景移除（抠图）
- 图像质量优化
- 实时处理进度显示

### 🎬 视频生成
- AI 视频生成
- 多种提示词模板
- 视频预览和管理
- Live Photo 导出

### 🖼️ 贴纸管理
- 贴纸收藏和分类
- 详细视图和编辑
- 系列化管理
- 云端同步

## 技术架构

### 核心组件
- **CameraView**: 相机拍摄界面，支持点击对焦
- **CollectionView**: 贴纸收藏管理
- **StickerDetailView**: 贴纸详情和编辑
- **VideoManagementView**: 视频生成和管理
- **HapticFeedbackManager**: 统一触觉反馈

### 服务层
- **ImageEnhancementService**: AI 图像增强服务
- **KlingAPIService**: 视频生成 API 服务
- **SupabaseService**: 云端存储服务

### 技术栈
- **开发语言**: Swift 5.0+
- **UI 框架**: SwiftUI
- **最低版本**: iOS 18.4+
- **相机框架**: AVFoundation
- **图像处理**: Core Image, Vision
- **网络请求**: URLSession
- **数据存储**: UserDefaults, Supabase

## 开发环境

### 要求
- Xcode 16.0+
- iOS 18.4+ 模拟器或设备
- Swift 5.0+

### 编译和运行
```bash
# 克隆项目
git clone [repository-url]

# 打开项目
open jitata.xcodeproj

# 选择目标设备并运行
# 支持 iPhone 和 iPad
```

### 环境配置
项目需要配置以下环境变量（在 `.env` 文件中）：
```
TUZI_API_KEY=your_api_key
TUZI_API_BASE=your_api_base_url
SUPABASE_URL=your_supabase_url
SUPABASE_ANON_KEY=your_supabase_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key
SUPABASE_STORAGE_BUCKET=jitata-images
```

## 项目结构

```
jitata/
├── Views/
│   ├── Camera/
│   │   ├── CameraView.swift          # 主相机界面
│   │   ├── CameraPreviewView.swift   # 相机预览组件
│   │   ├── PhotoPreviewView.swift    # 照片预览
│   │   └── ImageCropView.swift       # 图像裁剪
│   ├── Collection/
│   │   ├── CollectionView.swift      # 贴纸收藏
│   │   └── StickerDetailView.swift   # 贴纸详情
│   ├── Components/
│   │   ├── VideoManagementView.swift # 视频管理
│   │   ├── StickerCard.swift         # 贴纸卡片
│   │   └── VideoGenerationButton.swift
│   └── HomeView.swift                # 主页面
├── Services/
│   ├── ImageEnhancementService.swift # AI 增强服务
│   ├── KlingAPIService.swift         # 视频生成服务
│   └── SupabaseService.swift         # 云端存储
├── Utils/
│   └── HapticFeedbackManager.swift   # 触觉反馈管理
├── Models/
│   └── ToySticker.swift              # 贴纸数据模型
└── Assets.xcassets                   # 应用资源
```

## 许可证
[许可证信息]

## 贡献
欢迎提交 Issue 和 Pull Request 来改进项目。

---
*最后更新: 2024-12-06*