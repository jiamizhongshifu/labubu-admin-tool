# Jitata - 潮玩虚拟图鉴应用

一个创新的潮玩收集应用，让你轻松拍摄、收集和管理你的潮流玩具。

## ✨ 核心功能

### 📸 智能拍摄系统
- **真实相机预览**: 集成AVFoundation，提供实时相机画面
- **专业拍摄界面**: 
  - 左上角显示当天日期和拍摄提示
  - 中央280x280像素取景框，四角装饰线设计
  - 底部80像素圆形拍摄按钮和60像素方形相册入口
  - 黑色专业背景，营造拍摄氛围
- **权限管理**: 完善的相机权限检查和模拟器适配
- **拍摄状态指示**: 实时显示拍摄进度和状态

### 🖼️ 拍摄预览系统
- **智能预览界面**: 拍摄完成后自动跳转到预览页面
- **透明背景抠图**: AI自动抠图生成PNG格式的透明背景图像 ✨
- **操作按钮组**:
  - **裁剪按钮**: 支持图片裁剪功能
  - **确认按钮**: 保存到图鉴
  - **取消按钮**: 重新拍摄
- **识别模式切换**: 右上角按钮可切换显示原图或抠图结果
- **实时处理状态**: 显示图像处理进度

### 🎨 AI智能抠图与增强
- **透明背景生成**: 使用Vision框架生成真正的透明背景PNG图像 ✨
- **AI图片增强**: 集成OpenAI gpt-image-1模型，自动增强抠图后的主体图像 ✨
- **智能提示词**: 根据不同分类（玩具、手办、模型、卡片等）使用专门优化的提示词
- **网络优化**（已全面增强）:
  - 超时配置: 请求60秒，资源180秒（针对小文件传输优化）
  - 智能重试: 最多3次，指数退避算法（最大30秒延迟）
  - 网络检查: 增强前自动检查连接状态和API服务器连通性
  - 错误分类: 区分可重试和不可重试错误，针对性处理
  - 延迟策略: 网络连接问题10秒基础延迟，超时问题8秒，连接问题6秒
  - 连接优化: 使用"Connection: close"避免连接复用问题，禁用缓存和管道
  - 图片极度压缩: 限制50KB以内，尺寸256px，质量0.03-0.3，确保传输成功率
- **多重算法支持**: 
  - Vision框架主体分离
  - VisionKit高级处理
  - 人像分割降级方案
- **智能降级机制**: 自动选择最佳处理方案
- **精确蒙版处理**: 使用CIBlendWithMask确保透明背景效果

### 📱 用户界面
- **现代化主页**: 渐变背景设计，卡片式功能入口
- **完善的导航系统**: ✨
  - 图鉴页面添加返回按钮
  - 清晰的导航栏标题显示
  - 一致的用户体验流程
- **响应式设计**: 适配不同iOS设备尺寸

### 🗂️ 图鉴管理
- **分类收藏**: 支持玩具、手办、模型、卡片等分类
- **智能搜索**: 按名称、分类、备注搜索
- **多视图模式**: 网格视图和列表视图切换
- **详细信息**: 每个潮玩包含完整的收藏信息
- **AI增强状态**: 显示图片增强进度和状态

## 🛠️ 技术栈

- **语言**：Swift 5.9+
- **框架**：SwiftUI
- **最低版本**：iOS 16.0+
- **核心技术**：
  - VisionKit：智能图像分析和背景移除
  - SwiftData：本地数据持久化
  - Core Image：图像处理和特效
  - AVFoundation：相机功能
  - OpenAI API：AI图片增强服务

## 🔧 开发环境配置

### 系统要求
- Xcode 15.0+
- iOS 16.0+ 模拟器或真机
- macOS 14.0+

### 环境变量配置
应用需要配置OpenAI API密钥以启用AI图片增强功能：

#### 方法一：.env文件配置（推荐）
在项目根目录创建`.env`文件：
```bash
# OpenAI API配置
TUZI_API_KEY=your_api_key_here
TUZI_API_BASE=https://api.tu-zi.com/v1
```

#### 方法二：环境变量
```bash
export TUZI_API_KEY="your_api_key_here"
export TUZI_API_BASE="https://api.tu-zi.com/v1"
```

#### 方法三：Info.plist配置（开发环境）
在项目的Info.plist中添加：
```xml
<key>OPENAI_API_KEY</key>
<string>your_api_key_here</string>
```

#### API密钥获取
- 访问 [api.tu-zi.com](https://api.tu-zi.com) 注册账号
- 创建API密钥时选择OpenAI、OpenAI原价或default分组
- 复制密钥并配置到环境变量中

**注意**: 请确保API密钥的安全性，不要将其提交到版本控制系统中。

## 📱 界面设计

### 拍照界面特色
- **黑色背景**：专业的拍照体验
- **日期显示**：左上角显示当前日期（如"6月04日"）
- **拍摄提示**：清晰的操作指导文字
- **取景框**：280x280的圆角矩形框，带有四角装饰线
- **拍摄按钮**：80px圆形白色按钮，简洁优雅
- **相册入口**：右下角60px方形按钮，便于选择已有照片

## 🚀 开发进度

- [x] **Phase 1: 基础架构** - 项目结构和数据模型
- [x] **Phase 2: 拍照功能** - 相机集成和图像处理
- [x] **Phase 3: 图鉴功能** - 收藏管理和展示
- [x] **Phase 4: 界面优化** - 现代化拍照界面设计
- [x] **Phase 5: 用户体验** - 主页设计和流程优化
- [x] **Phase 6: 预览系统** - 真实相机预览和拍摄预览
- [x] **Phase 7: 功能完善** - 分享、导出等高级功能
- [x] **Phase 8: 透明背景修复** - 修复抠图白色背景问题
- [x] **Phase 9: 导航体验优化** - 优化图鉴页面导航
- [x] **Phase 10: AI图片增强** - 集成OpenAI API实现智能图片增强

## 📋 最新更新

### v2.0.2 - API配置标准化
- 🔧 API配置优化：支持TUZI_API_KEY和TUZI_API_BASE环境变量
- 📁 .env文件支持：优先从.env文件读取API配置
- 🔄 向后兼容：保持对OPENAI_API_KEY的支持
- 📊 调试信息增强：显示API配置加载状态
- 🛠️ 参数优化：移除无效的quality参数，添加n参数

### v2.0.1 - AI增强网络优化
- 🔧 修复API参数错误：quality参数从"hd"改为"high"
- 🌐 网络连接优化：增加超时时间到120秒/300秒
- 🔄 智能重试策略：网络连接问题使用5-15秒延迟
- 📡 连接稳定性提升：禁用缓存，优化连接设置
- 🛠️ 错误处理改进：更精确的网络错误分类和处理

### v2.0.0 - AI图片增强功能
- 🤖 集成OpenAI gpt-image-1模型，实现AI图片增强
- 🎯 智能提示词管理，针对不同分类优化增强效果
- 🔄 自动增强流程，保存图片后自动触发AI增强
- 📊 增强状态管理，实时显示处理进度
- 🎨 优先显示增强后的图片，提升视觉效果
- 🔧 环境变量配置，安全管理API密钥
- 💾 智能存储管理，为Supabase迁移做准备

### v1.4.0 - 新增真实相机预览和拍摄预览
- 🎨 全新的拍照界面设计
- 📅 添加日期显示功能
- 🎯 精美的取景提示框
- 🔘 优化拍摄按钮和相册入口布局
- 🐛 修复编译警告和代码优化
- 🎨 新增真实相机预览和拍摄预览功能
- 🎨 实时显示拍摄进度和状态

## 📝 使用说明

1. **环境配置**：配置OpenAI API密钥到环境变量
2. **进入应用**：启动后看到精美的主页，选择功能入口
3. **拍照收集**：点击"拍照收集"进入拍摄界面
4. **实时预览**：查看相机画面和取景框
5. **点击拍摄**：自动拍照并处理
6. **预览确认**：查看抠图结果，可裁剪调整
7. **保存收藏**：为你的潮玩起个名字，选择分类，保存到图鉴
8. **AI增强**：系统自动调用AI服务增强图片质量
9. **管理查看**：在"我的图鉴"中查看和管理所有收藏

## 🎯 设计理念

Jitata致力于为潮玩爱好者提供最简单、最智能的收集体验。通过先进的AI技术和精美的界面设计，让每一次拍摄都成为艺术创作。AI增强功能让普通的拍摄照片变得更加精美，为每个潮玩创造独特的数字身份。

## 📚 技术文档

- [VisionKit 官方文档](https://developer.apple.com/documentation/visionkit)
- [OpenAI API 文档](https://api.tu-zi.com)

---

*让每个潮玩都有自己的数字身份* 🎭 

## 技术实现细节

### AI图片增强模块 (ImageEnhancementService)

**核心功能**: 使用OpenAI API对潮玩图片进行AI增强处理

**API调用合规性**: ✅ 完全符合官方文档标准
- **API端点**: `/images/edits` - 符合官方文档（已修复404错误）
- **环境变量**: 支持 `TUZI_API_KEY` 和 `TUZI_API_BASE`（官方推荐）
- **向后兼容**: 同时支持 `OPENAI_API_KEY`（向后兼容）
- **配置来源**: 环境变量 → .env文件 → Info.plist → 硬编码备选

**请求参数**（完全符合官方文档）:
- `model`: "gpt-image-1" - 官方推荐模型
- `image`: PNG格式图片数据（必需）
- `prompt`: 分类特定的增强提示词（必需）
- `size`: "1024x1024" - 标准尺寸
- `quality`: "high" - 高质量渲染
- `n`: 1 - 生成图片数量
- `response_format`: "b64_json" - 官方推荐格式
- `background`: "opaque" - 不透明背景
- `moderation`: "auto" - 自动内容审核

**响应处理**（符合官方文档）:
- ✅ 优先处理 `b64_json` 格式（官方推荐）
- ✅ 备用处理 `url` 格式
- ✅ 完整的错误信息解析（type, code, message）
- ✅ 网络错误分类和智能重试机制

**网络优化**:
- 超时配置: 请求60秒，资源180秒（针对小文件传输优化）
- 智能重试: 最多3次，指数退避算法（最大30秒延迟）
- 网络检查: 增强前自动检查连接状态和API服务器连通性
- 错误分类: 区分可重试和不可重试错误，针对性处理
- 延迟策略: 网络连接问题10秒基础延迟，超时问题8秒，连接问题6秒
- 连接优化: 使用"Connection: close"避免连接复用问题，禁用缓存和管道
- 图片极度压缩: 限制50KB以内，尺寸256px，质量0.03-0.3，确保传输成功率

**提示词管理**: 
- 使用 `PromptManager.shared.getEnhancementPrompt(for: category)`
- 支持分类特定的专业提示词：玩具、手办、模型、卡片、其他
- 手办专用提示词：专注于细节增强、材质优化、光影效果

### 分类管理系统

**统一分类标准**: 
- 所有模块使用统一分类：玩具、手办、模型、卡片、其他
- 通过 `CategoryConstants.swift` 统一管理
- 确保与 `PromptManager` 分类一致性

**分类应用范围**:
- 图片处理确认页面
- AI增强提示词选择
- 数据模型分类字段
- 测试用例分类

### 背景移除功能

**技术方案**: 使用iOS原生VisionKit模块
- 与Capwords和苹果自带抠图保持一致
- 避免使用第三方API或非原生方案
- 确保最佳的用户体验和性能

### 数据模型

**ToySticker模型**:
- `categoryName`: 使用统一的分类名称
- `aiEnhancementStatus`: 增强状态管理
- `aiEnhancementProgress`: 实时进度跟踪
- `enhancedImageData`: 增强后的图片数据

### 环境配置

**API配置优先级**:
1. 环境变量 `TUZI_API_KEY` / `TUZI_API_BASE`
2. .env文件配置
3. Info.plist配置
4. 硬编码备选值

**开发环境设置**:
```bash
# 推荐的环境变量设置（符合官方文档）
export TUZI_API_KEY=sk-your-api-key
export TUZI_API_BASE=https://api.tu-zi.com/v1
```

### 错误处理和用户体验

**网络故障排除**:
- 自动网络连接检查
- 用户友好的错误提示
- 智能重试建议
- 网络切换指导

**进度反馈**:
- 实时进度显示
- 详细状态消息
- 可取消的长时间操作
- 批量处理支持 


**API调用文档**:
https://wiki.tu-zi.com/zh/Code/gpt-image-1-py
